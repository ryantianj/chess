self.addEventListener("message",(async e=>{let l=0;const o=(e,l)=>e.getScore(l),t=e=>e===h.BLACK?h.WHITE:h.BLACK,s=(e,l,o,n,i,r,w)=>{if(0===l)return[null,w*c(o,n,e,w,1)];const h=e.isGameOver(w);if(h.isGameOver&&w===r)return[null,-Number.MAX_VALUE];if(h.isGameOver&&w!==r)return[null,Number.MAX_VALUE];const a=h.allMoves,u=Math.floor(Math.random()*(a.length-1));let C=a.length>0?a[u]:null;if(i){let c=-Number.MAX_VALUE;for(const i of a){e.movePiece(i.piece,i);const h=s(e,l-1,o,n,!1,r,t(w))[1];if(e.undoMove(),h>c&&(c=h,C=i),n<=(o=Math.max(o,h)))break}return[C,c]}{let c=Number.MAX_VALUE;for(const i of a){e.movePiece(i.piece,i);const h=s(e,l-1,o,n,!0,r,t(w))[1];if(e.undoMove(),h<c&&(c=h,C=i),(n=Math.max(n,h))<=o)break}return[C,c]}},n=(e,l)=>null!==e.ate&&null!==l.ate?e.piece.points-e.ate.points<l.piece.points-l.ate.points?1:-1:null!==e.ate?-1:null!==l.ate?1:0,c=(e,l,s,i,r)=>{const w=o(s,i);if(0===r)return w;if(w>=l)return l;e=Math.max(e,w);const h=s.getAllMoves(i);h.sort(n);for(const o of h)if(null!==o.ate){s.movePiece(o.piece,o);let n=-c(-l,-e,s,t(i),r-1);if(s.undoMove(),n>=l)return l;n>e&&(e=n)}return e};class i{board;constructor(){this.board=this.newBoard(),this.moves=[]}newBoard=()=>[[new g(h.BLACK,new r(0,0)),new C(h.BLACK,new r(0,1)),new a(h.BLACK,new r(0,2)),new f(h.BLACK,new r(0,3)),new u(h.BLACK,new r(0,4)),new a(h.BLACK,new r(0,5)),new C(h.BLACK,new r(0,6)),new g(h.BLACK,new r(0,7))],[new d(h.BLACK,new r(1,0)),new d(h.BLACK,new r(1,1)),new d(h.BLACK,new r(1,2)),new d(h.BLACK,new r(1,3)),new d(h.BLACK,new r(1,4)),new d(h.BLACK,new r(1,5)),new d(h.BLACK,new r(1,6)),new d(h.BLACK,new r(1,7))],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[new d(h.WHITE,new r(6,0)),new d(h.WHITE,new r(6,1)),new d(h.WHITE,new r(6,2)),new d(h.WHITE,new r(6,3)),new d(h.WHITE,new r(6,4)),new d(h.WHITE,new r(6,5)),new d(h.WHITE,new r(6,6)),new d(h.WHITE,new r(6,7))],[new g(h.WHITE,new r(7,0)),new C(h.WHITE,new r(7,1)),new a(h.WHITE,new r(7,2)),new f(h.WHITE,new r(7,3)),new u(h.WHITE,new r(7,4)),new a(h.WHITE,new r(7,5)),new C(h.WHITE,new r(7,6)),new g(h.WHITE,new r(7,7))]];deepCopyBoard=()=>{};setBoardString=e=>{const l=[];for(let o=0;o<8;o++){const t=[];for(let l=0;l<8;l++){const s=e[o][l];if(null===s)t.push(null);else{const e="w"===s.slice(0,1)?h.WHITE:h.BLACK,n=s.slice(1,2);"b"===n?t.push(new a(e,new r(o,l))):"k"===n?t.push(new u(e,new r(o,l))):"n"===n?t.push(new C(e,new r(o,l))):"p"===n?t.push(new d(e,new r(o,l))):"q"===n?t.push(new f(e,new r(o,l))):"r"===n?t.push(new g(e,new r(o,l))):t.push(null)}}l.push(t)}this.board=l};clonePiece=e=>e instanceof d?new d(e.colour,new r(e.cell.row,e.cell.col)):e instanceof a?new a(e.colour,new r(e.cell.row,e.cell.col)):e instanceof u?new u(e.colour,new r(e.cell.row,e.cell.col)):e instanceof C?new C(e.colour,new r(e.cell.row,e.cell.col)):e instanceof f?new f(e.colour,new r(e.cell.row,e.cell.col)):e instanceof g?new g(e.colour,new r(e.cell.row,e.cell.col)):null;getBoard=()=>this.board;getPiece=(e,l)=>this.board[e][l];isEmpty=(e,l)=>!this.isOutSide(e,l)&&null===this.board[e][l];isUnderCheck=e=>!1;isOutSide=(e,l)=>e<0||l<0||e>7||l>7;canEat=(e,l,o)=>!this.isOutSide(e,l)&&!this.isEmpty(e,l)&&this.getPiece(e,l).colour!==o;canEatDefend=(e,l)=>!this.isOutSide(e,l)&&!this.isEmpty(e,l);canMove=(e,l)=>!this.isOutSide(e,l)&&this.isEmpty(e,l);canKingMove=(e,l,o)=>{const t=[[1,1],[-1,-1],[1,-1],[-1,1],[0,1],[1,0],[0,-1],[-1,0]];for(const s of t){const t=e+s[0],n=l+s[1];if(!this.isOutSide(t,n)&&!this.isEmpty(t,n)&&this.getPiece(t,n)instanceof u&&this.getPiece(t,n).colour!==o)return!1}return!0};getAttackingSquares=e=>{const l=[];for(let o=0;o<8;o++)for(let t=0;t<8;t++)if(!this.isEmpty(o,t)){const s=this.getPiece(o,t);if(s.colour!==e&&!(s instanceof u)){const e=s.getAttack(this);l.push.apply(l,e)}}return[l,[]]};movePiece=(e,l)=>{const o=this.board[l.oldCell.row][l.oldCell.col].movePiece(l,this);return this.moves.push(l),o};undoMove=()=>{if(this.moves.length>0){const e=this.moves.pop(),l=e.oldCell.row,o=e.oldCell.col,t=this.board[e.newCell.row][e.newCell.col];return this.board[l][o]=t,t.moves.pop(),t.cell.row=l,t.cell.col=o,e.isEnPassant?(this.board[e.ate.cell.row][e.ate.cell.col]=e.ate,this.board[e.newCell.row][e.newCell.col]=null,!0):(e.isPromotion?this.board[l][o]=new d(t.colour,t.cell,t.moves):e.castle.isCastle&&(this.board[e.castle.rook.oldCell.row][e.castle.rook.oldCell.col]=e.castle.rook.piece,e.castle.rook.piece.cell.row=e.castle.rook.oldCell.row,e.castle.rook.piece.cell.col=e.castle.rook.oldCell.col,this.board[e.castle.rook.newCell.row][e.castle.rook.newCell.col]=null),this.board[e.newCell.row][e.newCell.col]=e.ate,!0)}return!1};kingHasMoved=e=>{for(const l of this.moves)if(l.piece instanceof u&&l.piece.colour===e)return!0;return!1};rookHasMoved=(e,l)=>{const o=e===h.BLACK?0:7,t=l===u.KING_SIDE?7:0;if(!(this.getPiece(o,t)instanceof g))return!0;for(const s of this.moves)if(s.piece instanceof g&&s.piece.colour===e&&s.oldCell.row===o&&s.oldCell.col===t)return!0;return!1};castlingSquaresIsEmpty=(e,l)=>{const o=e===h.BLACK?0:7,t=l===u.KING_SIDE?[5,6]:[1,2,3];for(const s of t)if(!this.isEmpty(o,s))return!1;return!0};castlingSquaresUnderAttack=(e,l,o)=>{const t=e===h.BLACK?0:7,s=l===u.KING_SIDE?[4,5,6]:[1,2,3,4];for(const n of s)for(const e of o)if(e.newCell.row===t&&e.newCell.col===n)return!0;return!1};canCastle=(e,l,o)=>this.castlingSquaresIsEmpty(e,l)&&!this.castlingSquaresUnderAttack(e,l,o)&&!this.rookHasMoved(e,l)&&!this.kingHasMoved(e);promotePiece=e=>{const l=e.cell.row,o=e.cell.col;this.board[l][o]=e};isCheck=(e,l=null)=>{const o=null===l?this.getAttackingSquares(e)[0]:l;for(const t of o){const l=this.getPiece(t.newCell.row,t.newCell.col);if(l instanceof u&&l.colour===e)return!0}return!1};willCheck=(e,l)=>(this.movePiece(e,l),this.isCheck(e.colour)?(this.undoMove(),!0):(this.undoMove(),!1));getAllMoves=e=>{let l=[];for(let o=0;o<8;o++)for(let t=0;t<8;t++)null!==this.board[o][t]&&this.getPiece(o,t).colour===e&&(l=l.concat(this.getPiece(o,t).getMoves(this)));return l};isRepeatPosition=e=>{const l=e;if(this.moves.length>=l){const e=this.moves.slice(-l);let o=e[0],t=e[1];for(let s=2;s<l;s+=4){const l=e[s],n=e[s+1];if(l.newCell.row!==o.oldCell.row||l.newCell.col!==o.oldCell.col||o.piece!==l.piece)return!1;if(n.newCell.row!==t.oldCell.row||n.newCell.col!==t.oldCell.col||t.piece!==n.piece)return!1}return!0}return!1};isGameOver=e=>{const l=this.getAllMoves(e),o=this.isCheck(e),t=e===h.BLACK?"White":"Black";return o&&l.length<=0?{isGameOver:!0,message:t+" wins by checkmate",allMoves:l}:!o&&l.length<=0?{isGameOver:!1,message:"Draw by stalemate",allMoves:l}:this.isRepeatPosition(8)?{isGameOver:!1,message:"Draw by threefold repetition",allMoves:l}:{isGameOver:!1,message:"",allMoves:l}};getAllMoves=e=>{let l=[];for(let o=0;o<8;o++)for(let t=0;t<8;t++)if(!this.isEmpty(o,t)&&this.getPiece(o,t).colour===e){const e=this.getPiece(o,t).getMoves(this);l=l.concat(e)}return l};scanSquaresScore=(e,l,o)=>{let t=0,s=0;for(let n=0;n<8;n++)for(let o=0;o<8;o++){const c=this.getPiece(n,o);null!==c&&(c.colour===e&&(s+=c.points),c.colour!==e&&(s-=c.points),c instanceof d&&1!==n?t+=3:c instanceof C&&0!==n&&(1!==o||6!==o)?t+=10:c instanceof g&&0!==n&&(0!==o||7!==o)?t+=5:c instanceof a&&0!==n&&(2!==o||5!==o)&&(t+=10),c instanceof u&&(2===o||6===o)&&(t+=20),c instanceof d&&c.colour===e?this.getPiece(n+1,o)instanceof d&&c.colour===e&&(t-=20):c instanceof d&&c.colour!==e&&this.getPiece(n-1,o)instanceof d&&c.colour!==e&&(t+=20),c instanceof u&&c.colour===e&&this.isCheck(e,l)&&(t-=5))}return t+1e3*s};getScore=e=>{const l=e===h.WHITE?h.BLACK:h.WHITE,o=this.getAttackingSquares(l),t=o[0].length;return o[1].length,t+this.scanSquaresScore(e,o[0],o[1])};getBoardString=()=>{const e=[];for(let l=0;l<8;l++){const o=[];for(let e=0;e<8;e++){const t=this.getPiece(l,e);null!==t?o.push(t.getString()):o.push(null)}e.push(o)}return e}}class r{constructor(e,l){this.row=e,this.col=l}}class w{oldCell;newCell;constructor(e,l,o,t=!1,s={isCastle:!1},n=null,c=!1){this.oldCell=e,this.newCell=l,this.piece=o,this.isEnPassant=t,this.castle=s,this.ate=n,this.isPromotion=c}getMoveString=()=>({oldCellRow:this.oldCell.row,oldCellCol:this.oldCell.col,newCellRow:this.newCell.row,newCellCol:this.newCell.col,pieceString:this.piece.getString(),isEnPassant:this.isEnPassant,castle:!1===this.castle.isCastle?{isCastle:!1}:{isCastle:!0,rook:{pieceString:this.castle.rook.piece.getString(),oldCellRow:this.castle.rook.oldCell.row,oldCellCol:this.castle.rook.oldCell.col,newCellRow:this.castle.rook.newCell.row,newCellCol:this.castle.rook.newCell.col}},ate:null!==this.ate?this.ate.getString():null,isPromotion:this.isPromotion});static parseMove=(e,l)=>{const o=new w(new r(l.oldCellRow,l.oldCellCol),new r(l.newCellRow,l.newCellCol),e.getPiece(l.oldCellRow,l.oldCellCol),l.isEnPassant,{isCastle:!1},null,l.isPromotion);if(l.isPromotion&&e.promotePiece(new f(e.getPiece(l.oldCellRow,l.oldCellCol).colour,e.getPiece(l.oldCellRow,l.oldCellCol).cell)),l.castle.isCastle){const t=l.castle.rook;o.castle.isCastle=!0,o.castle.rook=new w(new r(t.oldCellRow,t.oldCellCol),new r(t.newCellRow,t.newCellCol),e.getPiece(t.oldCellRow,t.oldCellCol))}return o}}class h{static WHITE=-1;static BLACK=1;isAlive=!0;constructor(e,l,o=[]){this.colour=e,this.cell=l,this.moves=o}}class a extends h{directions=[[1,1],[-1,-1],[1,-1],[-1,1]];points=3;constructor(e,l,o){super(e,l,o)}getMoves=e=>{const l=[];for(const o of this.directions){const t=this.cell.row,s=this.cell.col,n=o[0],c=o[1];let i=n+t,h=c+s;for(;e.canMove(i,h)||e.canEat(i,h,this.colour);){const o=new w(this.cell,new r(i,h),this);if(e.willCheck(this,o)||l.push(o),e.canEat(i,h,this.colour))break;i+=n,h+=c}}return l};getAttack=e=>{const l=[];for(const o of this.directions){const t=this.cell.row,s=this.cell.col,n=o[0],c=o[1];let i=n+t,h=c+s;for(;(e.canMove(i,h)||e.canEatDefend(i,h))&&(l.push(new w(this.cell,new r(i,h),this)),!e.canEatDefend(i,h));)i+=n,h+=c}return l};movePiece=(e,l)=>{const o=l.getBoard(),t=e.newCell.row,s=e.newCell.col,n=o[t][s];return null!==n&&(e.ate=n),o[t][s]=this,o[e.oldCell.row][e.oldCell.col]=null,this.cell=new r(t,s),this.moves.push(e),{row:t,col:s}};getString=()=>(this.colour===h.WHITE?"w":"b")+"b"}class u extends h{directions=[[1,1],[-1,-1],[1,-1],[-1,1],[0,1],[1,0],[0,-1],[-1,0]];static KING_SIDE="king";static QUEEN_SIDE="queen";points=9999;constructor(e,l,o){super(e,l,o)}getMoves=e=>{const l=[],o=e.getAttackingSquares(this.colour)[0];for(const s of this.directions){const o=s[0],t=s[1],n=o+this.cell.row,c=t+this.cell.col;if((e.canEat(n,c,this.colour)||e.canMove(n,c))&&e.canKingMove(n,c,this.colour)){const o=new w(this.cell,new r(n,c),this);e.willCheck(this,o)||l.push(o)}}const t=l.filter((e=>{for(const l of o)if(e.newCell.row===l.newCell.row&&e.newCell.col===l.newCell.col)return!1;return!0}));if(e.canCastle(this.colour,u.KING_SIDE,o)){const l=this.colour===h.BLACK?0:7,o=6;t.push(new w(this.cell,new r(l,o),this,!1,{isCastle:!0,rook:new w(new r(l,7),new r(l,5),e.getPiece(l,7))}))}if(e.canCastle(this.colour,u.QUEEN_SIDE,o)){const l=this.colour===h.BLACK?0:7,o=2;t.push(new w(this.cell,new r(l,o),this,!1,{isCastle:!0,rook:new w(new r(l,0),new r(l,3),e.getPiece(l,0))}))}return t};getAttack=e=>this.getMoves(e);movePiece=(e,l)=>{const o=l.getBoard(),t=e.newCell.row,s=e.newCell.col;e.castle.isCastle&&(o[e.castle.rook.newCell.row][e.castle.rook.newCell.col]=e.castle.rook.piece,o[e.castle.rook.oldCell.row][e.castle.rook.oldCell.col]=null,e.castle.rook.piece.cell.row=e.castle.rook.newCell.row,e.castle.rook.piece.cell.col=e.castle.rook.newCell.col);const n=o[t][s];return null!==n&&(e.ate=n),o[t][s]=this,o[e.oldCell.row][e.oldCell.col]=null,this.cell=new r(t,s),this.moves.push(e),{row:t,col:s}};getString=()=>(this.colour===h.WHITE?"w":"b")+"k"}class C extends h{directions=[[1,2],[1,-2],[2,1],[2,-1],[-1,2],[-1,-2],[-2,1],[-2,-1]];points=3;constructor(e,l,o){super(e,l,o)}getMoves=e=>{const l=[];for(const o of this.directions){const t=o[0],s=o[1],n=t+this.cell.row,c=s+this.cell.col;if(e.canEat(n,c,this.colour)||e.canMove(n,c)){const o=new w(this.cell,new r(n,c),this);e.willCheck(this,o)||l.push(o)}}return l};getAttack=e=>{const l=[];for(const o of this.directions){const t=o[0],s=o[1],n=t+this.cell.row,c=s+this.cell.col;(e.canEatDefend(n,c)||e.canMove(n,c))&&l.push(new w(this.cell,new r(n,c),this))}return l};movePiece=(e,l)=>{const o=l.getBoard(),t=e.newCell.row,s=e.newCell.col,n=o[t][s];return null!==n&&(e.ate=n),o[t][s]=this,o[e.oldCell.row][e.oldCell.col]=null,this.cell=new r(t,s),this.moves.push(e),{row:t,col:s}};getString=()=>(this.colour===h.WHITE?"w":"b")+"n"}class d extends h{points=1;constructor(e,l,o){super(e,l,o)}getMoves=e=>{const l=[];let o=this.cell.row+1*this.colour,t=this.cell.col;if(e.canMove(o,t)){const s=new w(this.cell,new r(o,t),this,void 0,void 0,void 0,0===o||7===o);if(e.willCheck(this,s)||l.push(s),o=this.cell.row+2*this.colour,e.canMove(o,t)&&this.moves.length<=0)if(this.colour===h.BLACK&&1===this.cell.row){const s=new w(this.cell,new r(o,t),this);e.willCheck(this,s)||l.push(s)}else if(this.colour===h.WHITE&&6===this.cell.row){const s=new w(this.cell,new r(o,t),this);e.willCheck(this,s)||l.push(s)}}if(o=this.cell.row+1*this.colour,t=this.cell.col+1,e.canEat(o,t,this.colour)){const s=new w(this.cell,new r(o,t),this,void 0,void 0,e.getPiece(o,t),0===o||7===o);e.willCheck(this,s)||l.push(s)}if(e.canMove(o,t)&&e.moves.length>0){const s=e.moves.slice(-1)[0];if(s.piece instanceof d&&s.newCell.row===this.cell.row&&s.newCell.col===this.cell.col+1&&2===Math.abs(s.newCell.row-s.oldCell.row)){const s=new w(this.cell,new r(o,t),this,!0);e.willCheck(this,s)||l.push(s)}}if(o=this.cell.row+1*this.colour,t=this.cell.col-1,e.canEat(o,t,this.colour)){const s=new w(this.cell,new r(o,t),this,void 0,void 0,e.getPiece(o,t),0===o||7===o);e.willCheck(this,s)||l.push(s)}if(e.canMove(o,t)&&e.moves.length>0){const s=e.moves.slice(-1)[0];if(s.piece instanceof d&&s.newCell.row===this.cell.row&&s.newCell.col===this.cell.col-1&&2===Math.abs(s.newCell.row-s.oldCell.row)){const s=new w(this.cell,new r(o,t),this,!0);e.willCheck(this,s)||l.push(s)}}return l};getAttack=e=>{const l=[];let o=this.cell.row+1*this.colour,t=this.cell.col+1;return(e.canMove(o,t)||e.canEatDefend(o,t))&&l.push(new w(this.cell,new r(o,t),this)),o=this.cell.row+1*this.colour,t=this.cell.col-1,(e.canMove(o,t)||e.canEatDefend(o,t))&&l.push(new w(this.cell,new r(o,t),this)),l};movePiece=(e,l)=>{const o=l.getBoard(),t=e.newCell.row,s=e.newCell.col;if(e.isEnPassant){const t=l.moves.slice(-1)[0],s=o[t.newCell.row][t.newCell.col];null!==s&&(e.ate=s),o[t.newCell.row][t.newCell.col]=null}const n=o[t][s];return null!==n&&(e.ate=n),o[t][s]=this,o[e.oldCell.row][e.oldCell.col]=null,this.cell=new r(t,s),e.isPromotion?(o[t][s]=new f(this.colour,this.cell),{promotion:!0,row:t,col:s}):(this.moves.push(e),{row:t,col:s})};getString=()=>(this.colour===h.WHITE?"w":"b")+"p"}class f extends h{directions=[[1,1],[-1,-1],[1,-1],[-1,1],[0,1],[1,0],[0,-1],[-1,0]];points=9;constructor(e,l,o){super(e,l,o)}getMoves=e=>{const l=[];for(const o of this.directions){const t=this.cell.row,s=this.cell.col,n=o[0],c=o[1];let i=n+t,h=c+s;for(;e.canMove(i,h)||e.canEat(i,h,this.colour);){const o=new w(this.cell,new r(i,h),this);if(e.willCheck(this,o)||l.push(o),e.canEat(i,h,this.colour))break;i+=n,h+=c}}return l};getAttack=e=>{const l=[];for(const o of this.directions){const t=this.cell.row,s=this.cell.col,n=o[0],c=o[1];let i=n+t,h=c+s;for(;(e.canMove(i,h)||e.canEatDefend(i,h))&&(l.push(new w(this.cell,new r(i,h),this)),!e.canEatDefend(i,h));)i+=n,h+=c}return l};movePiece=(e,l)=>{const o=l.getBoard(),t=e.newCell.row,s=e.newCell.col,n=o[t][s];return null!==n&&(e.ate=n),o[t][s]=this,o[e.oldCell.row][e.oldCell.col]=null,this.cell=new r(t,s),this.moves.push(e),{row:t,col:s}};getString=()=>(this.colour===h.WHITE?"w":"b")+"q"}class g extends h{directions=[[0,1],[1,0],[0,-1],[-1,0]];points=5;constructor(e,l,o){super(e,l,o)}getMoves=e=>{const l=[];for(const o of this.directions){const t=this.cell.row,s=this.cell.col,n=o[0],c=o[1];let i=n+t,h=c+s;for(;e.canMove(i,h)||e.canEat(i,h,this.colour);){const o=new w(this.cell,new r(i,h),this);if(e.willCheck(this,o)||l.push(o),e.canEat(i,h,this.colour))break;i+=n,h+=c}}return l};getAttack=e=>{const l=[];for(const o of this.directions){const t=this.cell.row,s=this.cell.col,n=o[0],c=o[1];let i=n+t,h=c+s;for(;e.canMove(i,h)||e.canEatDefend(i,h);){const o=new w(this.cell,new r(i,h),this);if(l.push(o),e.canEatDefend(i,h))break;i+=n,h+=c}}return l};movePiece=(e,l)=>{const o=l.getBoard(),t=e.newCell.row,s=e.newCell.col,n=o[t][s];return null!==n&&(e.ate=n),o[t][s]=this,o[e.oldCell.row][e.oldCell.col]=null,this.cell=new r(t,s),this.moves.push(e),{row:t,col:s}};getString=()=>(this.colour===h.WHITE?"w":"b")+"r"}const p=e.data,v=((e,o,t)=>{try{l=0;const t=new i;return t.setBoardString(e),s(t,o,-Number.MAX_VALUE,Number.MAX_VALUE,!0,h.BLACK,h.BLACK)[0]}catch(n){alert("Engine error: "+n)}})(p[0],p[1],p[2]);postMessage(v.getMoveString())}));
//# sourceMappingURL=worker.worker.5f187d51.worker.js.map